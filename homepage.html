<!DOCTYPE html>
<html>
<head>
    <title>SaySo - Home</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>

<div class="layout">

    <!-- sidebar with links and the logged in username -->
    <aside class="sidebar">
        <div class="profile clickable" onclick="location.href='/profile'">
            <div class="avatar">ðŸ‘¤</div>
            <div class="username" id="sidebarUsername">USER</div>
        </div>

        <div class="menu-section">
            <h3>SaySo</h3>
            <a href="/homepage">Dashboard</a>
            <a href="/create-questionnaire">Create Questionnaire</a>
        </div>

        <div class="sidebar-bottom">
            <a href="/help">Help</a>
            <a href="/logout" class="logout">Logout</a>
        </div>
    </aside>

    <!-- main dashboard content -->
    <main class="content">
        <h1 style="color:#6b1f2b; text-align:center;">Welcome to SaySo!</h1>

        <div class="create-tile">
            <a href="/create-questionnaire">+</a>
            <p>Create Questionnaire</p>
        </div>

        <section class="questionnaires">
            <h2>Previous Questionnaires</h2>
            <div id="questionnaireList" class="questionnaire-list"></div>
        </section>
    </main>

</div>

<script>
// loads the username and shows it in the sidebar
fetch("/api/me")
.then(res => res.json())
.then(data => {
    if(!data.error) {
        document.getElementById("sidebarUsername").innerText = data.username;
    }
});

// loads all questionnaires for the logged in user
fetch("/api/my-questionnaires")
.then(res => res.json())
.then(data => {
    const container = document.getElementById("questionnaireList");
    container.innerHTML = "";

    // shows a message if there are no questionnaires
    if(data.length === 0){
        container.innerHTML = '<p class="empty">No questionnaires yet.</p>';
        return;
    }

    data.forEach(q => {
        const created = new Date(q.created_at).toLocaleString();
        const lastOpened = new Date(q.last_opened).toLocaleString();

        const row = document.createElement("div");
        row.className = "questionnaire-row";

        // builds the row html + the dropdown actions
        row.innerHTML = `
            <div>
                <strong>${q.title}</strong>
                <p>Created: ${created}</p>
                <p>Last opened: ${lastOpened}</p>
            </div>
            <div class="options">
                â‹®
                <div class="dropdown">
                    <a href="/view-questionnaire/${q.id}">View</a>
                    <a href="/edit-questionnaire/${q.id}">Edit</a>
                    <a href="/responses/${q.id}">Responses</a>
                    <a href="#" onclick="deleteQ(${q.id})">Delete</a>
                    <a href="/share/${q.id}">Share</a>
                </div>
            </div>
        `;

        container.appendChild(row);
    });
});

// deletes a questionnaire using the api
function deleteQ(id){
    if(!confirm("Are you sure you want to delete this questionnaire?")) return;
    fetch(`/api/questionnaires/${id}`, { method: "DELETE" })
    .then(res => res.json())
    .then(data => {
        if(data.success){
            window.location.reload();
        } else {
            alert("Error deleting questionnaire");
        }
    });
}
</script>

</body>
</html>
