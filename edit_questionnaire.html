<!DOCTYPE html>
<html>
<head>
    <title>Edit Questionnaire</title>
    <link rel="stylesheet" href="/static/style.css">
    <!-- specific styles for the question blocks and buttons -->
    <style>
        .question-block {
            background:#fff;
            border:1px solid #ccc;
            border-radius:12px;
            padding:15px;
            margin-bottom:10px;
        }
        .add-btn, .remove-btn {
            background:#6b1f2b;
            color:#fff;
            padding:8px 15px;
            border:none;
            border-radius:8px;
            margin-top:10px;
            cursor:pointer;
        }
        .remove-btn { background:#ff4d4d; }
        .add-btn:hover { background:#8b2a3b; }
        .remove-btn:hover { background:#ff6666; }
    </style>
</head>
<body>

<div class="layout">
    <!-- sidebar nav -->
    <aside class="sidebar">
        <div class="profile clickable" onclick="location.href='/profile'">
            <div class="avatar">ðŸ‘¤</div>
            <div class="username" id="username">USER</div>
        </div>
        <div class="menu-section">
            <h3>SaySo</h3>
            <a href="/homepage">Dashboard</a>
        </div>
        <div class="sidebar-bottom">
            <a href="/help">Help</a>
            <a href="/logout" class="logout">Logout</a>
        </div>
    </aside>

    <!-- main edit form -->
    <main class="content">
        <h1 style="color:#6b1f2b;">Edit Questionnaire</h1>

        <div class="container" style="max-width:600px;">
            <form id="editForm">
                <label>Questionnaire Title</label>
                <input type="text" id="title" required>

                <!-- questions get added here -->
                <div id="questionsContainer"></div>

                <button type="button" class="add-btn" id="addQuestion">+ Add Question</button>
                <button type="submit" class="add-btn" style="width:100%; margin-top:20px;">
                    Save Changes
                </button>
            </form>
        </div>
    </main>
</div>

<script>
/* loads the username into the sidebar */
fetch("/api/me")
.then(res => res.json())
.then(data => {
    if(!data.error) document.getElementById("username").innerText = data.username;
});

let questionCount = 0;
/* gets the questionnaire id from the url */
const questionnaireId = window.location.pathname.split("/").pop();

/* adds a new question block to the page */
function addQuestionBlock(text='', type='text') {
    questionCount++;

    const div = document.createElement('div');
    div.className = 'question-block';
    div.id = `question-${questionCount}`;

    div.innerHTML = `
        <label>Question ${questionCount}</label>
        <input type="text" value="${text}" required>
        <select>
            <option value="text" ${type==='text'?'selected':''}>Written Response</option>
            <option value="yesno" ${type==='yesno'?'selected':''}>Yes/No</option>
            <option value="scale" ${type==='scale'?'selected':''}>Scale 1-5</option>
        </select>
        <button type="button" class="remove-btn" onclick="this.parentElement.remove()">Remove</button>
    `;

    document.getElementById('questionsContainer').appendChild(div);
}

/* loads the saved questionnaire so the form is filled in */
fetch(`/api/questionnaire/${questionnaireId}`)
.then(res => res.json())
.then(data => {
    document.getElementById('title').value = data.title;
    data.questions.forEach(q => addQuestionBlock(q.text, q.qtype));
});

/* adds a blank question when the button is clicked */
document.getElementById('addQuestion')
.addEventListener('click', () => addQuestionBlock());

/* sends updated title + questions back to the backend */
document.getElementById('editForm')
.addEventListener('submit', async e => {
    e.preventDefault();

    const title = document.getElementById('title').value;
    const questions = [];

    document.querySelectorAll('.question-block').forEach(block => {
        questions.push({
            text: block.querySelector('input').value,
            qtype: block.querySelector('select').value
        });
    });

    const res = await fetch(`/api/questionnaire/${questionnaireId}`, {
        method: "PUT",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ title, questions })
    });

    const data = await res.json();
    if(data.success){
        window.location.href = "/homepage";
    } else {
        alert("Error updating questionnaire");
    }
});
</script>

</body>
</html>
